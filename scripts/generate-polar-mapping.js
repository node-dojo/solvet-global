#!/usr/bin/env node

/**
 * Generate Polar Product Mapping
 *
 * Creates a mapping file that connects website products to Polar checkout URLs
 * for download functionality.
 *
 * Prerequisites: Run create-checkout-links.js first to generate checkout links.
 */

const { Polar } = require('@polar-sh/sdk');
const fs = require('fs');
const path = require('path');

const POLAR_API_TOKEN = process.env.POLAR_API_TOKEN;
const POLAR_ORG_ID = process.env.POLAR_ORG_ID;

if (!POLAR_API_TOKEN || !POLAR_ORG_ID) {
  console.error('Error: POLAR_API_TOKEN and POLAR_ORG_ID required');
  process.exit(1);
}

const polar = new Polar({ accessToken: POLAR_API_TOKEN });

async function main() {
  console.log('ðŸ” Fetching products and checkout links from Polar...\n');

  // Load checkout links from file
  const checkoutLinksPath = path.join(__dirname, 'checkout-links.json');

  if (!fs.existsSync(checkoutLinksPath)) {
    console.error('âŒ Error: checkout-links.json not found!');
    console.error('Please run create-checkout-links.js first:\n');
    console.error('  POLAR_API_TOKEN=xxx POLAR_ORG_ID=xxx node scripts/create-checkout-links.js\n');
    process.exit(1);
  }

  const checkoutLinksData = JSON.parse(fs.readFileSync(checkoutLinksPath, 'utf8'));

  // Create a map of product ID to checkout URL
  const checkoutUrlMap = new Map();
  for (const link of checkoutLinksData) {
    checkoutUrlMap.set(link.productId, link.url);
  }

  console.log(`Loaded ${checkoutUrlMap.size} checkout links\n`);

  let allProducts;
  try {
    allProducts = await polar.products.list({
      organizationId: POLAR_ORG_ID,
      limit: 100
    });
  } catch (error) {
    if (error.body && typeof error.body === 'string') {
      allProducts = JSON.parse(error.body);
    } else {
      throw error;
    }
  }

  // Deduplicate - keep only latest version of each product
  const productMap = new Map();
  let skippedCount = 0;

  for (const product of allProducts.result.items) {
    const name = product.name;
    const createdAt = new Date(product.created_at);

    // Skip products without checkout links
    if (!checkoutUrlMap.has(product.id)) {
      console.log(`â­ï¸  Skipping ${product.name} (no checkout link)`);
      skippedCount++;
      continue;
    }

    if (!productMap.has(name) || createdAt > productMap.get(name).createdAt) {
      productMap.set(name, {
        id: product.id,
        name: product.name,
        description: product.description,
        createdAt: createdAt,
        url: checkoutUrlMap.get(product.id)  // Use checkout link URL
      });
    }
  }

  if (skippedCount > 0) {
    console.log(`\nâš ï¸  Skipped ${skippedCount} products without checkout links\n`);
  }

  // Sort by name
  const products = Array.from(productMap.values())
    .sort((a, b) => a.name.localeCompare(b.name));

  console.log(`Found ${products.length} unique products:\n`);
  products.forEach((p, i) => {
    console.log(`${i + 1}. ${p.name}`);
    console.log(`   ID: ${p.id}`);
    console.log(`   URL: ${p.url}\n`);
  });

  // Generate JavaScript mapping file
  const jsMapping = `// Polar Product Mapping
// Auto-generated by generate-polar-mapping.js
// Last updated: ${new Date().toISOString()}

const POLAR_PRODUCTS = {
${products.map(p => {
  // Convert product name to website-style ID
  const websiteId = p.name
    .toLowerCase()
    .replace(/\s+/g, '-')
    .replace(/[^a-z0-9-]/g, '')
    .replace(/-+/g, '-')
    .replace(/^-|-$/g, '');

  return `  '${websiteId}': {
    id: '${p.id}',
    name: '${p.name}',
    url: '${p.url}'
  }`;
}).join(',\n')}
};

// Polar organization base URL (checkout links)
const POLAR_ORG_URL = 'https://polar.sh/no3d-tools';

// Export for use in website
if (typeof module !== 'undefined' && module.exports) {
  module.exports = { POLAR_PRODUCTS, POLAR_ORG_URL };
}
`;

  // Write to file
  const outputPath = path.join(__dirname, '..', 'no3d-tools-website', 'polar-products.js');
  fs.writeFileSync(outputPath, jsMapping);

  console.log(`âœ… Mapping file generated: ${outputPath}\n`);
  console.log('ðŸ“‹ Next steps:');
  console.log('1. Include polar-products.js in your HTML');
  console.log('2. Update downloadProduct() function to use POLAR_PRODUCTS');
  console.log('3. Test downloads redirect to Polar correctly\n');
}

main().catch(error => {
  console.error('Error:', error.message);
  process.exit(1);
});
